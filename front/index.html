<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Clone</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¯ç”¨ Tailwind JIT æ¨¡å¼å’Œè‡ªå®šä¹‰é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // æ¨¡ä»¿ Gemini çš„ä¸»è¦é¢œè‰²
                        'gemini-bg': '#f7f9fc',
                        'gemini-blue': '#1a73e8',
                        'gemini-input': '#e8f0fe',
                    },
                    keyframes: {
                        // æ¶ˆæ¯æ¸å…¥åŠ¨ç”»
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        // æ¬¢è¿ç•Œé¢æ˜Ÿå›¢å‘¼å¸åŠ¨ç”»
                        pulseDot: {
                            '0%, 100%': { opacity: '0.4' },
                            '50%': { opacity: '1' },
                        },
                        // å…‰æ ‡é—ªçƒ
                        blink: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' },
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-dot': 'pulseDot 1.5s infinite ease-in-out',
                        'blink': 'blink 0.75s step-end infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        /* ç¡®ä¿è¾“å…¥æ¡†åœ¨èšç„¦æ—¶è¾¹æ¡†å¹³æ»‘è¿‡æ¸¡ */
        .input-wrapper:focus-within {
            border-color: #1a73e8 !important;
        }
        /* ç¡®ä¿ AI æ¶ˆæ¯åŒºåŸŸèƒ½æ˜¾ç¤ºæ¢è¡Œå’Œç©ºæ ¼ */
        .ai-typing-area {
            white-space: pre-wrap;
        }
        /* éšè—åŠŸèƒ½æç¤ºæ¡åœ¨èŠå¤©è¿›è¡Œæ—¶ */
        #tool-suggestions.hidden-suggestions {
             display: none !important;
        }
    </style>
</head>
<body class="bg-gemini-bg min-h-screen flex text-gray-800">

    <!-- å·¦ä¾§å¯¼èˆªæ  (æç®€é£æ ¼) -->
    <aside class="w-16 bg-white border-r border-gray-100 flex flex-col items-center py-4 space-y-6 flex-shrink-0">
        <button class="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition duration-150 group">
            <svg class="w-6 h-6 group-hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
        <a href="#" class="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
        </a>
        <div class="flex-grow"></div>
        <button class="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </button>
        <img class="w-8 h-8 rounded-full cursor-pointer mb-2" src="https://via.placeholder.com/150/1a73e8/ffffff?text=U" alt="ç”¨æˆ·å¤´åƒ">
    </aside>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="h-16 flex-shrink-0 flex items-center justify-between px-6 bg-white border-b border-gray-100">
            <h1 class="text-xl font-medium">Gemini</h1>
            <div class="flex items-center space-x-4">
                <button class="text-sm px-4 py-1.5 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition duration-150">å‡çº§</button>
            </div>
        </header>

        <!-- èŠå¤©å†…å®¹å®¹å™¨ -->
        <div id="chat-container" class="w-full flex-1 overflow-y-auto pt-10 pb-40 px-4 flex flex-col items-center">
            
            <!-- åˆå§‹æ¬¢è¿ç•Œé¢ (ä»¿ Gemini æ˜Ÿå›¢) -->
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="flex space-x-2 mb-6">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse-dot" style="animation-delay: 0s;"></div>
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse-dot" style="animation-delay: 0.2s;"></div>
                    <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse-dot" style="animation-delay: 0.4s;"></div>
                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse-dot" style="animation-delay: 0.6s;"></div>
                </div>
                <h1 class="text-6xl font-light text-gray-800 mb-2">æ˜Ÿå›¢ï¼Œä½ å¥½</h1>
                <p class="text-xl text-gray-500">æˆ‘å¯ä»¥ä¸ºä½ æä¾›åˆ›æ„ã€åä½œå’Œè§£å†³é—®é¢˜ã€‚</p>
            </div>
            
        </div>

        <!-- åº•éƒ¨è¾“å…¥æ¡†å’ŒåŠŸèƒ½åŒº -->
        <div class="absolute bottom-0 w-full flex justify-center p-4">
            <div class="w-full max-w-3xl bg-white shadow-2xl rounded-2xl p-4 border border-gray-100 flex flex-col space-y-3">
                
                <!-- åŠŸèƒ½æç¤ºåŒº (ä»¿ Gemini æç¤ºå¡ç‰‡) -->
                <div id="tool-suggestions" class="flex justify-center space-x-4 text-sm text-gray-600 transition-opacity duration-300">
                    <button class="p-3 bg-gemini-bg rounded-xl hover:bg-gray-200 transition duration-150 text-left w-1/4 flex flex-col justify-between">
                        <p>åˆ¶ä½œå›¾ç‰‡</p>
                        <span class="text-blue-500 text-xl mt-2">ğŸ¨</span>
                    </button>
                    <button class="p-3 bg-gemini-bg rounded-xl hover:bg-gray-200 transition duration-150 text-left w-1/4 flex flex-col justify-between">
                        <p>åˆ›ä½œè§†é¢‘è„šæœ¬</p>
                        <span class="text-red-500 text-xl mt-2">ğŸ¬</span>
                    </button>
                    <button class="p-3 bg-gemini-bg rounded-xl hover:bg-gray-200 transition duration-150 text-left w-1/4 flex flex-col justify-between">
                        <p>éšä¾¿å†™ç‚¹ä»€ä¹ˆ</p>
                        <span class="text-orange-500 text-xl mt-2">âœï¸</span>
                    </button>
                    <button class="p-3 bg-gemini-bg rounded-xl hover:bg-gray-200 transition duration-150 text-left w-1/4 flex flex-col justify-between">
                        <p>ç»™æˆ‘çš„ä¸€å¤©æ´»åŠ›</p>
                        <span class="text-green-500 text-xl mt-2">âœ¨</span>
                    </button>
                </div>

                <!-- èŠå¤©è¾“å…¥æ¡† -->
                <div class="input-wrapper flex items-center bg-white rounded-xl p-2 border border-gray-200 transition duration-200">
                    <input type="text" id="chat-input" placeholder="å‘ Gemini æé—®..." 
                           class="flex-1 bg-transparent p-2 text-lg text-gray-800 focus:outline-none"
                           autocomplete="off">
                    
                    <button id="stop-button" class="p-2 ml-2 text-gray-500 rounded-full hover:bg-gray-100 transition duration-150 hidden">
                         <!-- Stop/Cancel Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>

                    <button id="send-button" class="p-2 ml-2 bg-gemini-blue text-white rounded-full hover:bg-blue-600 transition duration-150 disabled:bg-gray-400 disabled:opacity-50" disabled>
                        <!-- Send Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </div>
                
                <!-- åº•éƒ¨å…è´£å£°æ˜ -->
                <p class="text-xs text-gray-400 text-center">Gemini å¯èƒ½ä¼šå‡ºé”™ã€‚è¯·ä»”ç»†æ ¸å®å…¶å›å¤ã€‚</p>
            </div>
        </div>
    </main>
    
    <script>
        // API æ¥å£åœ°å€ (ä½¿ç”¨æ‚¨åç«¯è¿è¡Œçš„å®Œæ•´åœ°å€)
        // æ³¨æ„: è¯·ç¡®ä¿æ‚¨çš„åç«¯è¿è¡Œåœ¨ http://localhost:8000
        const API_URL = 'http://localhost:8000/chat-stream'; 

        // DOM å…ƒç´ å¼•ç”¨
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const stopButton = document.getElementById('stop-button');
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const toolSuggestions = document.getElementById('tool-suggestions');

        // å…¨å±€çŠ¶æ€ï¼šç”¨äºå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
        let abortController = null;
        let isStreaming = false;

        // -------------------------
        // 1. äº‹ä»¶ç›‘å¬å’Œè¾“å…¥æ§åˆ¶
        // -------------------------

        // ç›‘å¬è¾“å…¥ï¼Œæ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€
        chatInput.addEventListener('input', () => {
            sendButton.disabled = chatInput.value.trim() === '' || isStreaming;
        });

        // ç›‘å¬å‘é€æŒ‰é’®ç‚¹å‡»å’Œå›è½¦é”®
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                e.preventDefault(); // é˜»æ­¢å›è½¦é»˜è®¤æ¢è¡Œ
                sendMessage();
            }
        });

        // ç›‘å¬åœæ­¢æŒ‰é’®ç‚¹å‡»
        stopButton.addEventListener('click', () => {
            if (abortController) {
                abortController.abort(); // å–æ¶ˆè¯·æ±‚
                handleStreamEnd();
            }
        });


        /**
         * æ»šåŠ¨èŠå¤©å®¹å™¨åˆ°åº•éƒ¨
         */
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * ç»“æŸæµå¼ä¼ è¾“åçš„çŠ¶æ€æ¸…ç†
         */
        function handleStreamEnd() {
            isStreaming = false;
            chatInput.disabled = false;
            sendButton.disabled = chatInput.value.trim() === '';
            stopButton.classList.add('hidden');
            
            // ç§»é™¤ AI å“åº”åŒºåŸŸçš„å…‰æ ‡åŠ¨ç”»
            const currentCursor = chatContainer.querySelector('.typing-cursor');
            if (currentCursor) {
                currentCursor.remove();
            }
            chatInput.focus();
        }

        /**
         * åˆ›å»ºå¹¶æ·»åŠ ä¸€ä¸ªæ–°çš„èŠå¤©æ°”æ³¡
         * @param {string} role - 'user' æˆ– 'ai'
         * @param {string} content - èŠå¤©å†…å®¹
         * @returns {HTMLElement} æ–°åˆ›å»ºçš„æ°”æ³¡å…ƒç´ 
         */
        function addMessage(role, content = '') {
            // ç§»é™¤æ¬¢è¿ç•Œé¢å’Œæç¤º
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
                welcomeMessage.remove(); 
                toolSuggestions.classList.add('hidden-suggestions');
            }

            const messageWrapper = document.createElement('div');
            // ä½¿ç”¨ max-w-full ä¿è¯åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½è‡ªé€‚åº”
            messageWrapper.classList.add('w-full', 'max-w-3xl', 'flex', 'mb-8', 'p-2', 'animate-fade-in'); 

            if (role === 'user') {
                messageWrapper.innerHTML = `
                    <img class="w-8 h-8 rounded-full mr-4 mt-1 flex-shrink-0" src="https://via.placeholder.com/150/1a73e8/ffffff?text=U" alt="User">
                    <div class="max-w-full text-gray-800 p-3 rounded-xl shadow-md bg-white border border-gray-100">
                        <p class="whitespace-pre-wrap">${content}</p>
                    </div>
                `;
            } else if (role === 'ai') {
                messageWrapper.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 mr-4 mt-1 flex items-center justify-center bg-gemini-blue rounded-full">
                         <!-- æ¨¡ä»¿ Gemini çš„é’»çŸ³å›¾æ ‡ -->
                        <div class="w-3 h-3 bg-white transform rotate-45"></div>
                    </div>
                    <div class="max-w-full text-gray-800 p-3 rounded-xl shadow-md bg-white border border-gray-100">
                        <!-- AI å“åº”å†…å®¹åŒºåŸŸ -->
                        <p id="ai-response-${Date.now()}" class="ai-typing-area"></p>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageWrapper);
            scrollToBottom();
            
            return role === 'ai' ? messageWrapper.querySelector('.ai-typing-area') : null;
        }

        /**
         * å‘é€ç”¨æˆ·æ¶ˆæ¯å¹¶å¤„ç† AI æµå¼å“åº”
         */
        async function sendMessage() {
            const question = chatInput.value.trim();
            if (!question || isStreaming) return;

            // 1. çŠ¶æ€è®¾ç½®
            isStreaming = true;
            abortController = new AbortController();
            
            // 2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡
            addMessage('user', question);

            // 3. æ¸…ç©ºè¾“å…¥æ¡†å¹¶ç¦ç”¨
            chatInput.value = '';
            chatInput.disabled = true;
            sendButton.disabled = true;
            stopButton.classList.remove('hidden'); // æ˜¾ç¤ºåœæ­¢æŒ‰é’®

            // 4. æ·»åŠ  AI æ¶ˆæ¯å ä½ç¬¦å¹¶è·å–æ¥æ”¶æ–‡æœ¬åŒºåŸŸ
            const aiResponseArea = addMessage('ai');
            
            // æ·»åŠ æ‰“å­—å…‰æ ‡åŠ¨ç”»
            const cursor = document.createElement('span');
            cursor.classList.add('typing-cursor', 'ml-1', 'inline-block', 'w-1', 'h-4', 'bg-gray-700', 'animate-blink');
            aiResponseArea.appendChild(cursor);

            try {
                // 5. å‘é€è¯·æ±‚
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question }),
                    signal: abortController.signal, // æŒ‚è½½ AbortSignal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // 6. å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // è§£ç å¹¶é™„åŠ  chunk
                    const chunk = decoder.decode(value, { stream: true });
                    fullResponse += chunk;
                    
                    // æ¨¡æ‹Ÿæ‰“å­—æœºæ•ˆæœï¼šæ›´æ–° DOM å¹¶ä¿æŒå…‰æ ‡åœ¨æœ«å°¾
                    aiResponseArea.textContent = fullResponse;
                    aiResponseArea.appendChild(cursor); 

                    // ä¿æŒæ»šåŠ¨åˆ°åº•éƒ¨
                    scrollToBottom();
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Stream request aborted by user.');
                    aiResponseArea.innerHTML += '<span class="text-yellow-600"> [è¯·æ±‚å·²å–æ¶ˆ]</span>';
                } else {
                    console.error('Stream chat failed:', error);
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    aiResponseArea.innerHTML += `<span class="text-red-500"> âŒ è¿æ¥å¤±è´¥æˆ–æœåŠ¡å™¨é”™è¯¯: ${error.message}</span>`;
                }
            } finally {
                // 7. æ¸…ç†çŠ¶æ€
                handleStreamEnd();
                abortController = null;
            }
        }
    </script>
</body>
</html>